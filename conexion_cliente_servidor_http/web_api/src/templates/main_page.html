{% extends "base.html" %}

{% block content %}

<div class="container mt-4">
    <h1>Main Page</h1>

    <h2>Users</h2>
    <table class="table mt-4">
        <tr>
            <th>RFID</th>
            <th>Name</th>
            <th>Last Name</th>
            <th>Doors</th>
            <th></th>
        </tr>
        {% for user in users %}
        <tr>
            <td>{{ user.rfid }}</td>
            <td>{{ user.nombre }}</td>
            <td>{{ user.apellidos }}</td>
            <td>
                        {% for door in user.puertas %}
                            {{ door.id_puerta }}
                        {% endfor %}
                    </td>
            <td>
                <a href="{{ url_for('edit_user', rfid=user.rfid) }}" class="btn btn-primary">Edit</a>
                <button onclick="deleteUser('{{ user.rfid }}')" class="btn btn-danger">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </table>

    <a href="{{ url_for('add_user') }}" class="btn btn-primary mt-4 mr-2">Add User</a>
    <a href="{{ url_for('add_door') }}" class="btn btn-primary mt-4 mr-2">Add Door</a>
    <a href="{{ url_for('list_doors') }}" class="btn btn-primary mr-2">List Doors</a>

    {# Add a link to access the logs #}
    <a href="{{ url_for('access_log') }}" class="btn btn-primary">Access Log</a>
</div>


<h2>Simulate Access Check</h2>
<button type="button" onclick="simulateSuccess()">Acceso concedido</button>
<input type="text" id="successRfid" placeholder="RFID">
<input type="text" id="successDoor" placeholder="Puerta">
<br>
<button type="button" onclick="simulateDenied()">Acceso denegado</button>
<input type="text" id="deniedRfid" placeholder="RFID">
<input type="text" id="deniedDoor" placeholder="Puerta">
<br>
<button type="button" onclick="simulateError()">Error de la base de datos</button>
<input type="text" id="errorRfid" placeholder="RFID">
<input type="text" id="errorDoor" placeholder="Puerta">
</div>

<script>
    function simulateSuccess() {
        // Get the RFID and door number from the input fields
        const rfid = document.getElementById('successRfid').value;
        const door = document.getElementById('successDoor').value;

        // Simulate a successful access check
        fetch(`/api/verificar_acceso?puerta=${door}&rfid=${rfid}`)
            .then(response => {
                if (response.ok) {
                    alert('Access granted');
                } else {
                    alert('Access denied');
                }
            })
            .catch(error => alert('Error: ' + error));
    }

    function simulateDenied() {
        // Get the RFID and door number from the input fields
        const rfid = document.getElementById('deniedRfid').value;
        const door = document.getElementById('deniedDoor').value;

        // Simulate an access check that is denied
        fetch(`/api/verificar_acceso?puerta=${door}&rfid=${rfid}`)
            .then(response => {
                if (response.ok) {
                    alert('Access granted');
                } else {
                    alert('Access denied');
                }
            })
            .catch(error => alert('Error: ' + error));
    }

    function simulateError() {
        // Get the RFID and door number from the input fields
        const rfid = document.getElementById('errorRfid').value;
        const door = document.getElementById('errorDoor').value;

        // Simulate an error
        fetch(`/api/verificar_acceso?puerta=${door}&rfid=${rfid}`)
            .then(response => {
                if (response.ok) {
                    alert('Access granted');
                } else {
                    alert('Access denied');
                }
            })
            .catch(error => alert('Error: ' + error));
    }

function deleteUser(rfid) {
    if (confirm('Are you sure you want to delete this user?')) {
        // Send a POST request to the /users/<rfid> endpoint with the RFID as a parameter in the body
        fetch('/api/delete_user/', {
            method: 'POST',
            body: 'rfid=' + rfid
        }).then(function(response) {
            if (response.ok) {
                // If the response is successful, refresh the page
                window.location.reload();
            } else {
                // Otherwise, display an error message
                alert('Error deleting user with RFID: ' + rfid);
            }
        });
    }
}


</script>
{% endblock %}
